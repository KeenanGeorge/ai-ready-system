name: CI

on:
  push:
    branches: [ main, features ]
  pull_request:
    branches: [ main, features ]

env:
  GO_VERSION: '1.22'
  TESTMO_SOURCE: 'go-ci'

jobs:
  test:
    name: Run Tests and Upload to Testmo
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for commit info

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install gotestsum
      run: go install gotest.tools/gotestsum@latest

    - name: Install Testmo CLI
      run: npm install -g @testmo/testmo-cli

    - name: Create reports directory
      run: mkdir -p reports

    - name: Run tests with coverage and generate JUnit report
      run: |
        gotestsum --format=standard-verbose \
          --junitfile=reports/unit-tests.xml \
          --jsonfile=reports/test-results.json \
          --coverprofile=coverage.out \
          --covermode=atomic \
          ./...

    - name: Generate coverage report
      run: |
        go tool cover -html=coverage.out -o reports/coverage.html
        go tool cover -func=coverage.out > reports/coverage.txt

    - name: Get commit info
      id: commit
      run: |
        echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
        echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT
        echo "message=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT

    - name: Create Testmo run
      id: testmo
      run: |
        RUN_ID=$(testmo run create \
          --name "CI: ${{ steps.commit.outputs.branch }} - ${{ steps.commit.outputs.sha }}" \
          --source "${{ env.TESTMO_SOURCE }}" \
          --milestone "CI Automation" \
          --config "Go ${{ env.GO_VERSION }}")
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

    - name: Submit test results to Testmo
      run: |
        testmo run submit \
          --run-id "${{ steps.testmo.outputs.run_id }}" \
          --results reports/unit-tests.xml \
          --coverage reports/coverage.txt

    - name: Complete Testmo run
      run: |
        testmo run complete --run-id "${{ steps.testmo.outputs.run_id }}"

    - name: Comment on PR with Testmo link
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const testmoUrl = `https://app.testmo.com/automation/runs/${{ steps.testmo.outputs.run_id }}`;
          const comment = `## ðŸ§ª Test Results Uploaded to Testmo
          
          âœ… **CI Status**: Tests passed successfully
          
          ðŸ“Š **Testmo Run**: [View Results](${testmoUrl})
          
          ðŸ“ˆ **Coverage**: Generated and uploaded
          
          ðŸ”— **Run ID**: \`${{ steps.testmo.outputs.run_id }}\`
          
          ---
          *This comment was automatically generated by the CI pipeline*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          reports/
          coverage.out
        retention-days: 30

    - name: Check test coverage threshold
      run: |
        COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "Total coverage: ${COVERAGE}%"
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "Coverage below 80% threshold: ${COVERAGE}%"
          exit 1
        fi
        echo "Coverage threshold met: ${COVERAGE}%"
